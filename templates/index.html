<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能文档问答助手</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(120deg, #e0e7ff 0%, #f0fdfa 100%);
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            transition: background 1.5s ease-in-out;
        }
        
        body.app-mode {
            background: linear-gradient(120deg, #f8fafc 0%, #e0e7ff 100%);
        }
        .welcome-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #e0e7ff 0%, #f0fdfa 100%);
            text-align: center;
            padding: 2rem;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .welcome-container.fade-out {
            opacity: 0;
            transform: translateY(-50px) scale(0.95) rotateX(10deg);
            filter: blur(10px);
        }
        .welcome-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 2rem;
            background: linear-gradient(90deg, #3B82F6 0%, #06b6d4 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            animation: pulse 2s infinite;
        }
        .welcome-logo svg {
            width: 60px;
            height: 60px;
            fill: white;
        }
        .welcome-title {
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 0.08em;
            background: linear-gradient(90deg, #3B82F6 10%, #06b6d4 50%, #10B981 90%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            margin-bottom: 1rem;
            animation: fadeUp 1s ease-out;
        }
        .welcome-subtitle {
            color: #64748b;
            font-size: 1.4rem;
            margin-bottom: 3rem;
            max-width: 800px;
            animation: fadeUp 1.2s ease-out;
        }
        .welcome-button {
            padding: 1.2rem 3rem;
            font-size: 1.3rem;
            font-weight: 700;
            border-radius: 16px;
            background: linear-gradient(90deg, #3B82F6 0%, #06b6d4 100%);
            color: #fff;
            border: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            animation: fadeUp 1.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        .welcome-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5);
        }
        .welcome-button::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }
        .welcome-button:hover::after {
            left: 100%;
        }
        .app-container {
            opacity: 0;
            visibility: hidden;
            min-height: 100vh;
            width: 100%;
            transform: translateY(30px) scale(0.98);
            filter: blur(5px);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .app-container.fade-in {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            filter: blur(0);
        }
        .main-title {
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 0.08em;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 25%, #1e40af 50%, #2563eb 75%, #0ea5e9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            margin-bottom: 0.8rem;
            text-align: center;
            position: relative;
            padding: 2rem 0;
        }
        
        .main-title::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 2px;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        .main-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, #0ea5e9 0%, #06b6d4 100%);
            border-radius: 1px;
            animation: titleGlow 3s ease-in-out infinite alternate;
            animation-delay: 1.5s;
        }
        
        @keyframes titleGlow {
            0% { 
                opacity: 0.6; 
                transform: translateX(-50%) scaleX(0.8); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) scaleX(1.2); 
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            }
        }
        
        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1.3rem;
            margin-bottom: 3rem;
            position: relative;
            padding: 0 2rem;
            font-weight: 500;
            letter-spacing: 0.02em;
        }
        
        .subtitle::before {
            content: '✨';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }
        
        .subtitle::after {
            content: '🚀';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
            animation-delay: 1s;
        }
        
        @keyframes sparkle {
            0%, 100% { 
                transform: translateY(-50%) scale(1); 
                opacity: 0.7; 
            }
            50% { 
                transform: translateY(-50%) scale(1.2); 
                opacity: 1; 
            }
        }
        .main-container {
            width: 94%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px 10px;
            display: flex;
            gap: 25px;
            justify-content: space-between;
            align-items: flex-start;
        }
        .left-panel {
            flex: 2.8;
            display: flex;
            flex-direction: column;
        }
        .right-panel {
            flex: 2.2;
            display: flex;
            flex-direction: column;
        }
        .card {
            background: rgba(255,255,255,0.96);
            border-radius: 28px;
            box-shadow: 0 8px 32px 0 rgba(59,130,246,0.10), 0 2px 12px 0 rgba(16,185,129,0.10);
            padding: 30px 25px;
            margin-bottom: 20px;
            width: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(59,130,246,0.15), 0 4px 15px 0 rgba(16,185,129,0.15);
        }
        .input-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }
        textarea {
            width: 100%;
            min-height: 90px;
            font-size: 1.1rem;
            border-radius: 16px;
            border: 1.5px solid #c7d2fe;
            background: #f8fafc;
            padding: 16px;
            margin-bottom: 1.5rem;
            transition: border 0.2s, box-shadow 0.2s;
            resize: vertical;
        }
        textarea:focus {
            border: 1.5px solid #3B82F6;
            box-shadow: 0 0 0 2px #3B82F655;
            outline: none;
        }
        .submit-btn {
            width: 100%;
            padding: 16px 0;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 16px;
            background: linear-gradient(90deg, #3B82F6 0%, #06b6d4 100%);
            color: #fff;
            border: none;
            box-shadow: 0 2px 12px #3B82F655;
            transition: background 0.2s, box-shadow 0.2s, filter 0.2s;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .submit-btn:hover {
            filter: brightness(1.08) drop-shadow(0 4px 16px #3B82F6cc);
        }
        .submit-btn::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }
        .submit-btn:hover::after {
            left: 100%;
        }
        .section-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 16px;
        }
        .section-title svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            fill: #3B82F6;
        }
        .result-box, .doc-list-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            font-size: 14px;
            line-height: 1.6;
            position: relative;
            /* 确保没有滚动条 */
            overflow: visible !important;
            overflow-x: visible !important;
            overflow-y: visible !important;
            max-height: none !important;
            height: auto !important;
        }
        .doc-list-box {
            min-height: 300px; /* 为文档搜索窗口添加最小高度 */
        }
        .doc-item {
            background: #e0f2fe;
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px #38bdf822;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .doc-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
        }
        .doc-item:last-child { margin-bottom: 0; }
        .doc-title {
            font-size: 1rem;
            font-weight: 600;
            color: #0e7490;
            margin-bottom: 4px;
        }
        .doc-content {
            font-size: 1rem;
            color: #334155;
            margin-bottom: 2px;
            white-space: pre-line;
        }
        .doc-meta {
            font-size: 0.92rem;
            color: #64748b;
        }
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto 3rem auto;
            padding: 0 3rem;
            position: relative;
        }
        
        .progress-container::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 1px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            animation: progressGlow 4s ease-in-out infinite;
        }
        
        @keyframes progressGlow {
            0%, 100% { opacity: 0.3; width: 200px; }
            50% { opacity: 1; width: 400px; }
        }
        
        .progress-bar {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }
        .progress-bar::before {
            content: "";
            position: absolute;
            top: 50%;
            height: 8px;
            width: 100%;
            background: linear-gradient(90deg, #f1f5f9, #e2e8f0, #f1f5f9);
            z-index: 1;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-line {
            position: absolute;
            top: 50%;
            height: 8px;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 25%, #1e40af 50%, #2563eb 75%, #0ea5e9 100%);
            z-index: 2;
            transition: width 1.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            animation: progressPulse 2s ease-in-out infinite;
        }
        
        @keyframes progressPulse {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            }
            50% { 
                box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
            }
        }
        
        .progress-step {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #64748b;
            z-index: 3;
            position: relative;
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), inset 0 1px 2px rgba(255,255,255,0.5);
            border: 3px solid #ffffff;
            font-size: 1.1rem;
        }
        .progress-step.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            animation: activeStepPulse 2s infinite;
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        .progress-step.completed {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            transform: scale(1.08);
            box-shadow: 0 6px 18px rgba(16, 185, 129, 0.4), inset 0 1px 2px rgba(255,255,255,0.3);
            font-size: 0; /* 隐藏数字 */
        }
        
        .progress-step.completed::after {
            content: '✓';
            position: absolute;
            font-size: 1.4rem;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        @keyframes activeStepPulse {
            0% { 
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5), 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% { 
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5), 0 0 0 15px rgba(59, 130, 246, 0);
            }
            100% { 
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5), 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        
        .progress-label {
            position: absolute;
            bottom: -3rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            color: #4b5563;
            white-space: nowrap;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        /* 新增动画效果 */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .analysis-animation {
            animation: slideIn 0.5s ease forwards;
        }
        .answer-animation {
            animation: fadeIn 0.5s ease forwards;
        }
        .doc-item-animation {
            animation: slideIn 0.3s ease forwards;
            animation-fill-mode: both;
        }
        /* 分析流程动画 */
        .analysis-process {
            display: flex;
            align-items: center;
            margin: 15px 0;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }
        .analysis-process.active {
            opacity: 1;
            transform: translateY(0);
        }
        .analysis-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e7ff;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .analysis-icon svg {
            width: 24px;
            height: 24px;
            fill: #4f46e5;
        }
        .analysis-content {
            flex-grow: 1;
        }
        .analysis-title {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 4px;
        }
        .analysis-detail {
            color: #64748b;
            font-size: 0.95rem;
        }
        /* 流程分析指示器 */
        .process-indicator {
            position: relative;
            display: flex;
            align-items: center;
            padding: 10px 0;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.5s ease;
        }
        .process-indicator.active {
            opacity: 1;
            transform: translateX(0);
        }
        .indicator-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #3B82F6;
            margin-right: 12px;
            position: relative;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }
        .indicator-dot::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: white;
        }
        .indicator-text {
            font-size: 0.95rem;
            color: #3B82F6;
            font-weight: 500;
        }

        /* 响应式设计优化 */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                gap: 15px;
            }
            .left-panel, .right-panel {
                width: 100%;
            }
            .card {
                padding: 20px 15px;
            }
        }
        @media (max-width: 640px) {
            .main-title {
                font-size: 2rem;
            }
            .subtitle {
                font-size: 1rem;
                margin-bottom: 1.5rem;
            }
            .progress-container {
                padding: 0 1rem;
            }
            .progress-step {
                width: 2rem;
                height: 2rem;
                font-size: 0.9rem;
            }
            .progress-label {
                font-size: 0.75rem;
                bottom: -1.8rem;
            }
            .welcome-title {
                font-size: 2.5rem;
            }
            .welcome-subtitle {
                font-size: 1.1rem;
            }
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: #3B82F6;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .markdown-heading {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 700;
            color: #2563eb;
        }

        .markdown-h2 {
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 1.5rem;
        }

        .markdown-list {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .markdown-list li {
            margin-bottom: 0.5rem;
        }

        .markdown-code-block {
            background: #f1f5f9;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
            position: relative;
        }

        .markdown-code-block::before {
            content: "代码";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
            background: rgba(255, 255, 255, 0.5);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .markdown-inline-code {
            background: #f1f5f9;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
            color: #3b82f6;
        }

        .welcome-container.fade-out .welcome-logo {
            animation: logoExit 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        
        .welcome-container.fade-out .welcome-title {
            animation: titleExit 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) 0.05s forwards;
        }
        
        .welcome-container.fade-out .welcome-subtitle {
            animation: subtitleExit 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) 0.1s forwards;
        }
        
        .welcome-container.fade-out .welcome-button {
            animation: buttonExit 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) 0.15s forwards;
        }

        @keyframes logoExit {
            0% { transform: scale(1) rotateY(0deg); opacity: 1; }
            100% { transform: scale(0.8) rotateY(180deg); opacity: 0; }
        }
        
        @keyframes titleExit {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(0.9); opacity: 0; }
        }
        
        @keyframes subtitleExit {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(0.95); opacity: 0; }
        }
        
        @keyframes buttonExit {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(40px) scale(1.1); opacity: 0; }
        }

        .app-container.fade-in .main-title {
            animation: mainTitleEnter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s forwards;
            opacity: 0;
        }
        
        .app-container.fade-in .subtitle {
            animation: subtitleEnter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.4s forwards;
            opacity: 0;
        }
        
        .app-container.fade-in .progress-container {
            animation: progressEnter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.5s forwards;
            opacity: 0;
        }
        
        .app-container.fade-in .main-container {
            animation: containerEnter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.6s forwards;
            opacity: 0;
        }

        @keyframes mainTitleEnter {
            0% { transform: translateY(-30px) scale(0.9); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        @keyframes subtitleEnter {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes progressEnter {
            0% { transform: translateY(20px) scale(0.95); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        @keyframes containerEnter {
            0% { transform: translateY(30px) scale(0.98); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        .result-box.prose {
            /* 智能回答区域特殊样式，完全无滚动条 */
            overflow: visible !important;
            overflow-x: visible !important; 
            overflow-y: visible !important;
            max-height: none !important;
            height: auto !important;
            /* 覆盖任何外部CSS的可能影响 */
            max-width: none !important;
            width: 100% !important;
            /* 覆盖Tailwind CSS prose默认样式 */
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* IE/Edge */
        }
        
        /* 隐藏webkit浏览器的滚动条 */
        .result-box.prose::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        /* 确保所有容器元素都没有滚动条 */
        #answer, #analysis, #doc-list {
            overflow: visible !important;
            overflow-x: visible !important;
            overflow-y: visible !important;
            max-height: none !important;
            height: auto !important;
            /* 全面隐藏滚动条 */
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* IE/Edge */
        }
        
        /* 隐藏所有主要容器的webkit滚动条 */
        #answer::-webkit-scrollbar,
        #analysis::-webkit-scrollbar,
        #doc-list::-webkit-scrollbar,
        .result-box::-webkit-scrollbar,
        .doc-list-box::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        /* 确保Markdown内容元素也没有滚动条 */
        .markdown-code-block {
            overflow-x: auto !important; /* 代码块保持横向滚动以防代码过长 */
            overflow-y: visible !important;
        }
    </style>
</head>
<body>
    <!-- 欢迎页面 -->
    <div id="welcome-page" class="welcome-container">
        <div class="welcome-logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                <circle cx="12" cy="20" r="2" fill="currentColor"/>
                <path d="M8 4c0-.55.45-1 1-1s1 .45 1 1-.45 1-1 1-1-.45-1-1zm6 0c0-.55.45-1 1-1s1 .45 1 1-.45 1-1 1-1-.45-1-1z"/>
            </svg>
        </div>
        <h1 class="welcome-title">智能文档问答助手</h1>
        <p class="welcome-subtitle">基于千问大模型，智能分析文档，快速获取准确答案</p>
        <button id="start-app" class="welcome-button">开始使用</button>
    </div>

    <!-- 主应用页面 -->
    <div id="app-container" class="app-container">
        <div class="main-title">智能文档问答助手</div>
        <div class="subtitle">基于千问大模型，智能分析文档，快速获取准确答案</div>
        
        <!-- 流程进度条 -->
        <div class="progress-container">
            <div class="progress-bar">
                <div id="progress-line" class="progress-line" style="width: 0%"></div>
                <div id="step-1" class="progress-step active">
                    1
                    <span class="progress-label">提问</span>
                </div>
                <div id="step-2" class="progress-step">
                    2
                    <span class="progress-label">分析</span>
                </div>
                <div id="step-3" class="progress-step">
                    3
                    <span class="progress-label">搜索</span>
                </div>
                <div id="step-4" class="progress-step">
                    4
                    <span class="progress-label">回答</span>
                </div>
            </div>
        </div>
        
        <div class="main-container">
            <!-- 左侧：提问与结果 -->
            <div class="left-panel">
                <div class="card">
                    <form id="questionForm">
                        <div class="input-label">请输入您的问题：</div>
                        <textarea id="question" name="question" placeholder="例如：如何配置服务器？" required></textarea>
                        <button type="submit" class="submit-btn">提交问题</button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 2C13.1 2 14 2.9 14 4V8C14 9.1 13.1 10 12 10S10 9.1 10 8V4C10 2.9 10.9 2 12 2M21 9V7L19 5.5L17 7V9C17 10.1 17.9 11 19 11S21 10.1 21 9M7 9V7L5 5.5L3 7V9C3 10.1 3.9 11 5 11S7 10.1 7 9M12 10.5C13.25 10.5 14.31 11.12 14.94 12.04C16.39 12.64 17.5 13.97 17.5 15.5C17.5 17.43 15.93 19 14 19H10C8.07 19 6.5 17.43 6.5 15.5C6.5 13.97 7.61 12.64 9.06 12.04C9.69 11.12 10.75 10.5 12 10.5M9 16.5C9.83 16.5 10.5 15.83 10.5 15S9.83 13.5 9 13.5 7.5 14.17 7.5 15 8.17 16.5 9 16.5M15 16.5C15.83 16.5 16.5 15.83 16.5 15S15.83 13.5 15 13.5 13.5 14.17 13.5 15 14.17 16.5 15 16.5M12 20C12.55 20 13 20.45 13 21S12.55 22 12 22 11 21.55 11 21 11.45 20 12 20Z"/>
                        </svg>
                        问题分析
                    </div>
                    <div id="analysis" class="result-box">
                        <div id="analysis-indicators" class="analysis-indicators"></div>
                    </div>
                    
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/>
                        </svg>
                        智能回答
                    </div>
                    <div id="answer" class="result-box prose"></div>
                </div>
            </div>
            
            <!-- 右侧：文档分段 -->
            <div class="right-panel">
                <div class="card">
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                        </svg>
                        检索到的文档分段
                    </div>
                    <div id="doc-list" class="doc-list-box"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        marked.setOptions({ breaks: true, gfm: true, headerIds: true, mangle: false, sanitize: false });
        const State = { 
            ws: null, 
            markdownAnswer: '',
            currentStep: 1
        };

        // 欢迎页面处理
        document.getElementById('start-app').addEventListener('click', function() {
            // 添加淡出动画类
            document.getElementById('welcome-page').classList.add('fade-out');
            
            // 立即开始背景过渡
            document.body.classList.add('app-mode');
            
            // 延迟显示应用页面，给动画充足时间
            setTimeout(() => {
                document.getElementById('welcome-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                // 添加淡入动画类
                setTimeout(() => {
                    document.getElementById('app-container').classList.add('fade-in');
                    // 延迟聚焦，确保动画完成后再聚焦
                    setTimeout(() => {
                        document.getElementById('question').focus();
                    }, 400);
                }, 50);
            }, 800); // 减少到0.8秒，配合新的快速动画
        });

        // 进度条处理函数
        function updateProgressBar(step) {
            State.currentStep = step;
            document.getElementById('progress-line').style.width = `${(step - 1) * 33.33}%`;
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                stepEl.classList.toggle('active', i === step);
                stepEl.classList.toggle('completed', i < step);
                if (i > step) {
                    stepEl.classList.remove('active', 'completed');
                }
            }
        }

        // 分析流程指示器和流程块合并动画触发
        function addAnalysisIndicator(title, detail) {
            const indicators = document.getElementById('analysis-indicators');
            const indicator = document.createElement('div');
            indicator.className = 'process-indicator';
            indicator.innerHTML = `<div class="indicator-dot"></div><div class="indicator-text">${title}: ${detail}</div>`;
            indicators.appendChild(indicator);
            setTimeout(() => { indicator.classList.add('active'); }, 100);
        }

        function addAnalysisProcess(title, content, iconPath) {
            const analysisEl = document.getElementById('analysis');
            const processDiv = document.createElement('div');
            processDiv.className = 'analysis-process';
            processDiv.innerHTML = `<div class="analysis-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">${iconPath}</svg></div><div class="analysis-content"><div class="analysis-title">${title}</div><div class="analysis-detail">${content}</div></div>`;
            analysisEl.appendChild(processDiv);
            setTimeout(() => { processDiv.classList.add('active'); }, 100);
        }

        // WebSocket 处理
        function connectWS() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            State.ws = new WebSocket(wsProtocol + '://' + window.location.host + '/ws/ask');
            State.ws.onopen = () => {
                const question = document.getElementById('question').value;
                State.ws.send(JSON.stringify({question: question}));
                updateProgressBar(2);
                document.getElementById('analysis').innerHTML = '<div id="analysis-indicators" class="analysis-indicators"></div>';
                addAnalysisIndicator("开始处理", "正在分析问题...");
            };
            State.ws.onmessage = (event) => {
                handleWSMessage(JSON.parse(event.data));
            };
            State.ws.onerror = () => {
                document.getElementById('answer').innerHTML = '<span style="color:#ef4444">WebSocket连接出错</span>';
            };
        }
        
        function handleWSMessage(data) {
            if (data.step === 'analyzing' && data.message) {
                addAnalysisIndicator("分析中", data.message);
            }
            if (data.step === 'analyzed' && data.analysis) {
                updateProgressBar(3);
                addAnalysisProcess(
                    "问题分析完成", 
                    `<div><b>问题：</b> ${data.analysis.question}</div><div><b>关键词：</b> ${data.analysis.keywords.join('、')}</div><div><b>改写后问题：</b> ${data.analysis.rewritten || ''}</div>`,
                    '<path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>'
                );
            }
            if (data.step === 'searching') {
                updateProgressBar(3);
                addAnalysisIndicator("搜索中", "正在搜索相关文档...");
            }
            if (data.step === 'searched' && data.docs) {
                addAnalysisProcess(
                    "文档搜索完成", 
                    `已找到 ${data.docs.length} 条相关内容，耗时 ${data.time.toFixed(2)}s`,
                    '<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>'
                );
                showDocList(data.docs);
            }
            if (data.step === 'answering') {
                if (data.status === 'start') {
                    updateProgressBar(4);
                    if (!document.querySelector('.analysis-process:has(.analysis-title:contains("生成回答中"))')) {
                        addAnalysisIndicator("生成中", "正在生成智能回答...");
                    }
                    State.markdownAnswer = '';
                    document.getElementById('answer').innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
                    return;
                }
                if (data.chunk) {
                    State.markdownAnswer += data.chunk;
                    const answerBox = document.getElementById('answer');
                    answerBox.innerHTML = marked.parse(State.markdownAnswer);
                    enhanceMarkdown(answerBox);
                    document.querySelectorAll('#answer pre code').forEach((block) => { hljs.highlightBlock(block); });
                }
            }
            if (data.step === 'answered' && data.answer) {
                const answerBox = document.getElementById('answer');
                answerBox.innerHTML = marked.parse(data.answer);
                enhanceMarkdown(answerBox);
                document.querySelectorAll('#answer pre code').forEach((block) => { hljs.highlightBlock(block); });
                addAnalysisProcess(
                    "回答生成完成", 
                    `总耗时 ${data.total_time.toFixed(2)}s`,
                    '<path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>'
                );
            }
            if (data.step === 'error') {
                document.getElementById('answer').innerHTML = `<div class="error-message"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ef4444" width="24" height="24"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg><span>${data.message}</span></div>`;
                addAnalysisProcess(
                    "处理出错", 
                    data.message,
                    '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>'
                );
            }
        }
        
        // 增强Markdown渲染
        function enhanceMarkdown(container) {
            container.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
                h.classList.add('markdown-heading');
                if (h.tagName === 'H2') h.classList.add('markdown-h2');
            });
            container.querySelectorAll('ul, ol').forEach(list => list.classList.add('markdown-list'));
            container.querySelectorAll('pre').forEach(block => block.classList.add('markdown-code-block'));
            container.querySelectorAll('code:not(pre code)').forEach(code => code.classList.add('markdown-inline-code'));
            fixMarkdownStructure(container);
        }
        
        function showDocList(docs) {
            const list = document.getElementById('doc-list');
            if (!docs || docs.length === 0) {
                list.innerHTML = '<div class="text-gray-400 text-center">未检索到相关文档分段</div>';
                return;
            }
            list.innerHTML = '';
            docs.forEach((doc, idx) => {
                const docDiv = document.createElement('div');
                docDiv.className = 'doc-item doc-item-animation';
                docDiv.style.animationDelay = `${idx * 0.1}s`;
                docDiv.innerHTML = `<div class="doc-title">${idx + 1}. ${doc.文件名} [段落${doc.文段起始段落号}]</div><div class="doc-content">${doc.内容}</div><div class="doc-meta">关键词: ${doc.关键词.join('、')}</div><div class="doc-meta">上下文: ${doc.上下文}</div>`;
                list.appendChild(docDiv);
            });
        }
        
        document.getElementById('questionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            State.markdownAnswer = '';
            document.getElementById('analysis').innerHTML = '<div id="analysis-indicators" class="analysis-indicators"></div>';
            document.getElementById('answer').innerHTML = '';
            document.getElementById('doc-list').innerHTML = '';
            updateProgressBar(1);
            connectWS();
        });

        // 修复Markdown结构问题
        function fixMarkdownStructure(container) {
            let html = container.innerHTML;
            const codeOpenTags = html.match(/<pre><code>/g) || [];
            const codeCloseTags = html.match(/<\/code><\/pre>/g) || [];
            if (codeOpenTags.length > codeCloseTags.length) {
                html += '</code></pre>';
                container.innerHTML = html;
            }
            const orphanLiElements = container.querySelectorAll(':not(ul):not(ol) > li');
            orphanLiElements.forEach(li => {
                const ul = document.createElement('ul');
                const parent = li.parentNode;
                parent.replaceChild(ul, li);
                ul.appendChild(li);
            });
            container.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => {
                if (!heading.textContent.trim()) heading.remove();
            });
        }
    </script>
</body>
</html> 